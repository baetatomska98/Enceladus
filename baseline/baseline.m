clear all
close all

% T_res = 283.16; % reservoir Temperature [K]
% p_res = 611.2;  % reservoir Pressure [Pa]
% R = 461.5;      % water vapour gas constant [J/(kg K)]
% rho_res = p_res/(R*T_res); % reservoir density [kg/m^3]
k = 4/3;        % water vapour specific heat ratio

% channel geometry
% r = [6.31480124581277,6.29891839032670,6.28234245252154,6.26509709700798,6.24720674055898,6.22869651468572,6.20959222709719,6.18992032210417,6.16970784002998,6.14898237569241,6.12777203602249,6.10610539688748,6.08401145918672,6.06151960429047,6.03865954889246,6.01546129934877,5.99195510557569,5.96817141458057,5.94414082370023,5.91989403362184,5.89546180126184,5.87087489257867,5.84616403539528,5.82135987230730,5.79649291375295,5.77159349132025,5.74669171136698,5.72181740902822,5.69700010268592,5.67226894897395,5.64765269839154,5.62317965159683,5.59887761645137,5.57477386588509,5.55089509664989,5.52726738902888,5.50391616756633,5.48086616288208,5.45814137463236,5.43576503567683,5.41375957751019,5.39214659701409,5.37094682458347,5.35018009367876,5.32986531185331,5.31002043330294,5.29066243298204,5.27180728232795,5.25346992663296,5.23566426410031,5.21840312661801,5.20169826228132,5.18556031969209,5.16999883405985,5.15502221512709,5.14063773693767,5.12685152946468,5.11366857211069,5.10109268909047,5.08912654670315,5.07777165249739,5.06702835633051,5.05689585331898,5.04737218867474,5.03845426441873,5.03013784795990,5.02241758252478,5.01528699941991,5.00873853210612,5.00276353206087,4.99735228640184,4.99249403724210,4.98817700274423,4.98438839983821,4.98111446856493,4.97834049800451,4.97605085374635,4.97422900685473,4.97285756428196,4.97191830067816,4.97139219154493,4.97125944767752,4.97149955083846,4.97209129060327,4.97301280231713,4.97424160609946,4.97575464683186,4.97752833506305,4.97953858876310,4.98176087585790,4.98417025747338,4.98674143181811,4.98944877863182,4.99226640412623,4.99516818634436,4.99812782086316,5.00111886676447,5.00411479279839,5.00708902366312,5.01001498632527,5.01286615630431,5.01561610384537,5.01823853990444,5.02070736187070,5.02299669895095,5.02508095714199,5.02693486371727,5.02853351115525,5.02985240043766,5.03086748364721,5.03155520579516,5.03189254581102,5.03185705662750,5.03142690429588,5.03058090606837,5.02929856738583,5.02756011771128,5.02534654515127,5.02263962980954,5.01942197581945,5.01567704200385,5.01138917111343,5.00654361759712,5.00112657386024,4.99512519496918,4.98852762176348,4.98132300233920,4.97350151187013,4.96505437073609,4.95597386093053,4.94625334072250,4.93588725755092,4.92487115913202,4.91320170276404,4.90087666281589,4.88789493638985,4.87425654715133,4.85996264732151,4.84501551783223,4.82941856664495,4.81317632523929,4.79629444327893,4.77877968146652,4.76063990260134,4.74188406085728,4.72252218930082,4.70256538567228,4.68202579645593,4.66091659926764,4.63925198359139,4.61704712989874,4.59431818718772,4.57108224898057,4.54735732782189,4.52316232832136,4.49851701878751,4.47344200150116,4.44795868167954,4.42208923518393,4.39585657502580,4.36928431672834,4.34239674260200,4.31521876499420,4.28777588857539,4.26009417172465,4.23220018707962,4.20412098131678,4.17588403422931,4.14751721717056,4.11904875093237,4.09050716312802,4.06192124515043,4.03332000877671,4.00473264249056,3.97618846759442,3.94771689418335,3.91934737705287,3.89110937161256,3.86303228987756,3.83514545660931,3.80747806567681,3.78005913670894,3.75291747210773,3.72608161449189,3.69957980463869,3.67343993999156,3.64768953379951,3.62235567495335,3.59746498858214,3.57304359747218,3.54911708436901,3.52571045522139,3.50284810342456,3.48055377511796,3.45885053559111,3.43776073684886,3.41730598638557,3.39750711721517,3.37838415920228,3.35995631173682,3.34224191779241,3.32525843940633,3.30902243461637,3.29354953588719,3.27885443005636,3.26495083982758,3.25185150683569,3.23956817630571,3.22811158332496,3.21749144074499,3.20771642872669,3.19879418593983,3.19073130242468,3.18353331412111,3.17720469906755,3.17174887526908,3.16716820023168,3.16346397215616,3.16063643278317,3.15868477187728,3.15760713333601,3.15740062290638,3.15806131748937,3.15958427600969,3.16196355182592,3.16519220665348,3.16926232597017,3.17416503587219,3.17989052134542,3.18642804591519,3.19376597263500,3.20189178637288,3.21079211735177,3.22045276589850,3.23085872835394,3.24199422409514,3.25384272361856,3.26638697763192,3.27960904710045,3.29349033419233,3.30801161406631,3.32315306744368,3.33889431390535,3.35521444585395,3.37209206308011,3.38950530787078,3.40743190059753,3.42584917572148,3.44473411815157,3.46406339989232,3.48381341691698,3.50396032620214,3.52448008285936,3.54534847730018,3.56654117237040,3.58803374039050,3.60980170003907,3.63182055301681,3.65406582042961,3.67651307882954,3.69913799585382,3.72191636540274,3.74482414229853,3.76783747636849,3.79093274589680,3.81408659039113,3.83727594261133,3.86047805980918,3.88367055412990,3.90683142212785,3.92993907335042,3.95297235794645,3.97591059325710,3.99873358934924,4.02142167345375,4.04395571327284,4.06631713912323,4.08848796488383,4.11045080771926,4.13218890655270,4.15368613926397,4.17492703859134,4.19589680671788,4.21658132852566,4.23696718350383,4.25704165629884,4.27679274589790,4.29620917343915,4.31528038864463,4.33399657487476,4.35234865280541,4.37032828273150,4.38792786550320,4.40514054210368,4.42196019187954,4.43838142943775,4.45439960022516,4.47001077480917,4.48521174188031,4.50000000000000];
r_av = 0.06;
A = 0.01;
x = linspace(0,1.5,301);
% r = zeros(length(x),1);
% x_th = 0.75;
% r_max = 0.07;
% r_th = 0.05;
% r(1:76) = r_max - (r_max - r_th)/x_th * x(1:76);
% r(77:end) = r_th + (r_max - r_th)/x_th * (x(77:end) - x_th);
r = r_av + A * cos(2*pi*x/x(end));
% r = zeros(length(x),1);
% r(1:76) = r_av + A * cos(2*pi*x(1:76)/0.75);
% r(77:end) = r_av + A * cos(2*pi*(x(77:end)+0.75)/2.25);
% taper_conv = pi/180 * 0.737;
% taper_div = pi/180 * 0.949;
% xp = 0.07 - 0.05 * sin(taper_conv);
% rp = 0.05265 - 0.05 * cos(taper_conv);
% xq = 0.07 + 0.05 * sin(taper_div);
% rq = 0.05265 - 0.05 * cos(taper_div);
% r_in = 0.0031;
% r_th = 0.00265;
% x_th = 0.07;
% r_fillet = 0.05;
% r_out = 0.0041;
% x_out = 0.245;
% for p = 1:length(x)
%     if x(p) < xp
%         r(p) = r_in + (rp - r_in)/xp * x(p);
%     elseif (x(p) >= xp) && (x(p) < xq)
%         r(p) = r_fillet + r_th - sqrt(r_fillet^2 - (x(p) - x_th)^2);
%     else
%         r(p) = rq + (r_out - rq)/(x_out - xq) * (x(p) - xq);
%     end
% end
r_throat = min(r);
throat = find(r_throat == r); %n-loaction of throat
if length(throat) > 1
    disp("Warning: 2 locations for throat found")
end
throat = throat(1);
% A = pi*r.^2;    % channel cross-sectional area [m^2]
% A_thr = pi*3.15^2; % channel throat area [m^2]
M = zeros(1, length(x));
% Tr = zeros(1, length(x));
pr = zeros(1, length(x));
for i = 1:length(x)
    if i < throat
        [M(i), ~, pr(i), ~, ~] = flowisentropic(k, r(i)/r_throat, 'sub');
    else
        [M(i), ~, pr(i), ~, ~] = flowisentropic(k, r(i)/r_throat, 'sup');
    end
end
% T = Tr * T_res;                         % Temperature throughout the channel [K]
% p = pr * p_res;                         % Pressure throghout the channel [K]
% rho = p./(R * T);                       % Density throughout the channel [kg/m^3]
A = [M; x; zeros(1,length(x)); zeros(1,length(x)); pr];
fid = fopen('L150/L150_isentr.csv','w');
fprintf(fid,'%6s,%6s,%6s,%6s,%6s\n','Ma_Magnitude','Points_0','Points_1','Points_2','p_p0');
fprintf(fid,'%12.8f,%12.8f,%12.8f,%12.8f,%12.8f\n',A);
fclose(fid);
